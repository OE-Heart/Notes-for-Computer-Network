# WEEK 4

## 网络层

## 网络互连

## 网际协议IP







### 分类IP 地址

- 每一类地址都由两个固定长度的字段组成，其中一个字段是网络号net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号host-id，它标志该主机（或路由器）

- 两级的IP地址可以记为：

  <img src="picture/image-20210324134249250.png" alt="image-20210324134249250" style="zoom: 67%;" />





### IP地址的重要特点

- IP 地址是一种分等级的地址结构。分两个等级的好处是：
  - IP 地址管理机构在分配IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了IP 地址的管理
  - 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间
- 实际上IP 地址是标志一个主机（或路由器）和一条链路的接口
  - 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP 地址，其网络号net-id 必须是不同的。这种主机称为多归属主机(multihomed host)
  - 由于一个路由器至少应当连接到两个网络（这样它才能将IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的IP地址
- 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号net-id
- 所有分配到网络号net-id 的网络，范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的







### 地址解析协议ARP

- 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址
- 每一个主机都设有一个ARP 高速缓存(ARPcache)，里面有所在的局域网上的各主机和路由器的IP地址到硬件地址的映射表
- 当主机A欲向本局域网上的某个主机B发送IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址



### ARP高速缓存的作用

- 为了减少网络上的通信量，主机A在发送其ARP请求分组时，就将自己的IP地址到硬件地址的映射写入ARP请求分组
- 当主机B收到A的ARP请求分组时，就将主机A的这一地址映射写入主机B自己的ARP高速缓存中。这对主机B以后向A发送数据报时就更方便了

> 注意：
>
> - ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题
> - 如果所要找的主机和源主机不在同一个局域网上，那么就要通过ARP找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做
> - 从IP地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的
> - 只要主机或路由器要和本网络上的另一个已知IP地址的主机或路由器进行通信，ARP协议就会自动地将该IP地址解析为链路层所需要的硬件地址

### 使用ARP的四种典型情况

- 发送方是主机，要把IP数据报发送到本网络上的另一个主机。这时用ARP找到目的主机的硬件地址
- 发送方是主机，要把IP数据报发送到另一个网络上的一个主机。这时用ARP找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成
- 发送方是路由器，要把IP 数据报转发到本网络上的一个主机。这时用ARP找到目的主机的硬件地址
- 发送方是路由器，要把IP 数据报转发到另一个网络上的一个主机。这时用ARP找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成

### 不直接使用硬件地址进行通信的原因

- 由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事
- 连接到因特网的主机都拥有统一的IP地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为调用ARP 来寻找某个路由器或主机的硬件地址都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的

### IP数据报的格式

- 一个IP数据报由首部和数据两部分组成
- 首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的
- 在首部的固定部分的后面是一些可选字段，其长度是可变的

<img src="picture/image-20210324142936398.png" alt="image-20210324142936398" style="zoom:67%;" />

- 版本占4 位，指IP 协议的版本，目前的IP 协议版本号为4 (即IPv4)
- 首部长度占4位，可表示的最大数值是15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节
- 区分服务占8位，用来获得更好的服务。在旧标准中叫做服务类型，但实际上一直未被使用过，1998年这个字段改名为区分服务。只有在使用区分服务(DiffServ)时，这个字段才起作用。在一般的情况下都不使用这个字段
- 总长度占16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为65535 字节。总长度必须不超过最大传送单元MTU
- 标识(identification) 占16 位，它是一个计数器，用来产生数据报的标识







### IP层转发分组的流程

- 有四个A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机
- 若按目的主机号来制作路由表，则所得出的路由表就会过于庞大
- 但若按主机所在的网络地址来制作路由表，那么每一个路由器中的路由表就只包含4 个项目。这样就可使路由表大大简化



### 查找路由表

- 根据目的网络地址就能确定下一跳路由器，这样做的结果是：
  - IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）
  - 只有到达最后一个路由器时，才试图向目的主机进行直接交付

### 默认路由(default route)

- 路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间
- 这种转发方式在一个网络只有很少的对外连接时是很有用的
- 默认路由在主机发送IP 数据报时往往更能显示出它的好处
- 如果一个主机连接在一个小网络上，而这个网络只用一个路由器和因特网连接，那么在这种情况下使用默认路由是非常合适的





## 划分子网

### 从二级IP地址到三级IP地址

- 在ARPANET 的早期，IP地址的设计确实不够合理
  - IP 地址空间的利用率有时很低
  - 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏
  - 两级的IP 地址不够灵活。
- 从1985 年起在IP 地址中又增加了一个“子网号字段”，使两级的IP 地址变成为三级的IP 地址
- 这种做法叫作划分子网(subnetting) 。划分子网已成为因特网的正式标准协议

### 基本思路

- 划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络

- 从主机号借用若干个位作为子网号subnet-id，而主机号host-id 也就相应减少了若干个位

  <img src="picture/image-20210324145308545.png" alt="image-20210324145308545" style="zoom:67%;" />

- 凡是从其他网络发送给本单位某个主机的IP数据报，仍然是根据IP数据报的目的网络号net-id，先找到连接在本单位网络上的路由器

- 然后此路由器在收到IP数据报后，再按目的网络号net-id和子网号subnet-id找到目的子网

- 最后就将IP数据报直接交付目的主机

